<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob Mating</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        header { background-color: #4CAF50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header .logo { font-size: 1.8em; font-weight: bold; cursor: pointer; }
        nav { display: flex; align-items: center; }
        nav a, nav button { margin-left: 20px; text-decoration: none; color: white; background: none; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; }
        nav a:hover, nav button:hover { background-color: rgba(255,255,255,0.2); }
        nav button#logoutButton { background-color: #e74c3c; }
        nav button#logoutButton:hover { background-color: #c0392b; }
        
        main { padding: 40px 20px; max-width: 900px; margin: 20px auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        
        /* Form & Section Styles */
        .form-section { display: none; margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .form-section.active { display: block; }
        input[type="text"], input[type="password"], input[type="number"], input[type="url"], select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        button[type="submit"], .action-button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; margin-top: 10px; }
        button[type="submit"]:hover, .action-button:hover { background-color: #218838; }
        
        .toggle-buttons { display: flex; justify-content: center; margin-bottom: 20px; }
        .toggle-buttons button { background-color: #6c757d; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin: 0 5px; }
        .toggle-buttons button.active { background-color: #007bff; }

        /* API Playground Specific Styles */
        .api-playground-section { padding: 20px; }
        .api-group { margin-bottom: 30px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa; }
        .api-group h3 { color: #495057; margin-top: 0; border-bottom: 1px dashed #ced4da; padding-bottom: 10px; }
        .api-group button { margin-bottom: 10px; width: auto; min-width: 150px; } /* Adjust button width */
        .api-group form { margin-top: 15px; }
        .api-group label { margin-bottom: 5px; display: block; font-weight: bold; }
        .api-group input[type="password"] { margin-bottom: 20px; } /* For password fields */
        
        pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9em; margin-top: 15px; }
    </style>
</head>
<body>
    <header>
        <div class="logo" data-route="/">Bob Mating</div>
        <nav>
            <a href="/auth" data-route="/auth" id="authNavButton">ë¡œê·¸ì¸/íšŒì›ê°€ì…</a>
            <a href="/profile" data-route="/profile" id="profileNavButton" style="display: none;">ë‚´ í”„ë¡œí•„</a>
            <a href="/api-playground" data-route="/api-playground" id="apiPlaygroundNavButton" style="display: none;">API Playground</a>
            <button id="logoutButton" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>
    </header>

    <main id="content">
        </main>

    <script>
        // --- API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜ ---
        const API = {
            signup: 'http://localhost:8080/api/user/signup',
            login: 'http://localhost:8080/api/auth/login',
            getProfile: 'http://localhost:8080/api/user/profile',
            updateProfile: 'http://localhost:8080/api/user/profile',
            updateEmail: 'http://localhost:8080/api/user/email',
            updatePhoneNumber: 'http://localhost:8080/api/user/phone-number',
            getUserDetails: 'http://localhost:8080/api/user/me/details',
            changePW: 'http://localhost:8080/api/user/password',
            logout: 'http://localhost:8080/api/auth/logout',
            withdraw: 'http://localhost:8080/api/user/withdraw',
            refresh: 'http://localhost:8080/api/auth/refresh',
            test: 'http://localhost:8080/api/test' // í…ŒìŠ¤íŠ¸ìš© API
        };

        // --- JWT í† í° ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ë° í•¨ìˆ˜ ---
        let accessToken = null;
        let refreshToken = null;
        let isRefreshing = false;
        let failedQueue = [];

        function loadTokens() {
            accessToken = localStorage.getItem('accessToken');
            refreshToken = localStorage.getItem('refreshToken');
            updateNavUI(); // ë„¤ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            console.log('âœ… í† í° ë¡œë“œ ì™„ë£Œ (ì•¡ì„¸ìŠ¤:', !!accessToken, 'ë¦¬í”„ë ˆì‹œ:', !!refreshToken, ')');
        }

        function saveTokens(access, refresh) {
            localStorage.setItem('accessToken', access);
            localStorage.setItem('refreshToken', refresh);
            accessToken = access;
            refreshToken = refresh;
            updateNavUI(); // ë„¤ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            console.log('âœ… í† í° ì €ì¥ ì™„ë£Œ.');
        }

        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            accessToken = null;
            refreshToken = null;
            updateNavUI(); // ë„¤ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            console.log('ğŸ—‘ï¸ í† í° ì œê±° ì™„ë£Œ.');
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë°”ì˜ ë²„íŠ¼ ê°€ì‹œì„±ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateNavUI() {
            const authNavButton = document.getElementById('authNavButton');
            const profileNavButton = document.getElementById('profileNavButton');
            const apiPlaygroundNavButton = document.getElementById('apiPlaygroundNavButton');
            const logoutButton = document.getElementById('logoutButton');

            if (authNavButton && profileNavButton && apiPlaygroundNavButton && logoutButton) {
                if (accessToken) {
                    authNavButton.style.display = 'none';
                    profileNavButton.style.display = 'inline';
                    apiPlaygroundNavButton.style.display = 'inline'; // ë¡œê·¸ì¸ ì‹œ API Playgroundë„ ë³´ì´ë„ë¡
                    logoutButton.style.display = 'inline';
                } else {
                    authNavButton.style.display = 'inline';
                    profileNavButton.style.display = 'none';
                    apiPlaygroundNavButton.style.display = 'none'; // ë¡œê·¸ì•„ì›ƒ ì‹œ API Playground ìˆ¨ê¹€
                    logoutButton.style.display = 'none';
                }
            }
        }

        // --- Fetch API ê¸°ë°˜ ìš”ì²­ í•¨ìˆ˜ (ì¸í„°ì…‰í„° ë¡œì§ í¬í•¨) ---
        async function fetchWithAuth(url, options = {}) {
            let headers = options.headers || {};
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            options.headers = headers;

            try {
                const response = await fetch(url, options);
                console.log(`âœ… [RESPONSE] ${response.status} ${url}`);

                if (response.status === 401 && !options._retry) {
                    options._retry = true;
                    console.log('ì•¡ì„¸ìŠ¤ í† í° ë§Œë£Œ ë˜ëŠ” ìœ íš¨í•˜ì§€ ì•ŠìŒ. ì¬ë°œê¸‰ ì‹œë„...');

                    try {
                        const newAccessToken = await doRefresh();
                        // --- ì—¬ê¸°ì— ë””ë²„ê¹… ë¡œê·¸ ìˆ˜ì • ì‹œì‘ ---
                        console.log('--- Debugging Retry Request Headers ---');
                        console.log('New Access Token from doRefresh:', newAccessToken ? newAccessToken.substring(0, 10) + '...' : 'null');
                        console.log('Current global accessToken:', accessToken ? accessToken.substring(0, 10) + '...' : 'null'); // ì „ì—­ ë³€ìˆ˜ í™•ì¸
                        
                        // ì¬ì‹œë„ ìš”ì²­ì— Authorization í—¤ë”ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì¬ì„¤ì •
                        headers['Authorization'] = `Bearer ${newAccessToken}`;
                        options.headers = headers; // options.headers ê°ì²´ì— ë³€ê²½ì‚¬í•­ ì ìš©

                        // Headers ê°ì²´ì˜ entries()ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ë¡œê¹…
                        // options.headersê°€ ì¼ë°˜ ê°ì²´ë¼ë©´ ê·¸ëŒ€ë¡œ ë¡œê¹…
                        // Headers ê°ì²´ë¼ë©´ Object.fromEntries(new Headers(options.headers).entries())
                        // ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ì€ `fetch`ê°€ ì ìš©í•  ìµœì¢… `Headers` ê°ì²´ë¥¼ ì§ì ‘ ë¡œê¹…í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
                        // `fetch`ëŠ” `options.headers`ê°€ ì¼ë°˜ ê°ì²´ì—¬ë„ `Headers` ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ì‚¬ìš©í•˜ë¯€ë¡œ,
                        // ì—¬ê¸°ì„œëŠ” `options.headers` ê°ì²´ ìì²´ë¥¼ ë¡œê¹…í•´ë„ ì¶©ë¶„í•©ë‹ˆë‹¤.
                        console.log('Retry request headers (will apply this):', { ...options.headers }); // ìˆ˜ì •ëœ ë¡œê¹…
                        console.log('--- End Debugging Retry Request Headers ---');
                        // --- ë””ë²„ê¹… ë¡œê·¸ ìˆ˜ì • ë ---

                        const retryResponse = await fetch(url, options);
                        console.log(`âœ… [RETRY RESPONSE] ${retryResponse.status} ${url}`);
                        return retryResponse;
                    } catch (refreshError) {
                        console.error('âŒ ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰ ì‹¤íŒ¨. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.', refreshError);
                        clearTokens();
                        navigate('/auth');
                        throw refreshError;
                    }
                }
                return response;
            } catch (error) {
                console.error(`âŒ [REQUEST ERROR] ${url}`, error);
                throw error;
            }
        }

        // --- í—¬í¼ í•¨ìˆ˜ë“¤ (API í˜¸ì¶œ ë¡œì§) ---

        async function doSignup(data) {
            const res = await fetchWithAuth(
                API.signup,
                { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('âœ… íšŒì›ê°€ì… ì™„ë£Œ');
            return res;
        }

        async function doLogin(data) {
            let res;
            try {
                res = await fetchWithAuth(
                    API.login,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
                );

                console.log('--- Debugging Login Response ---');
                console.log('Response URL:', res.url);
                console.log('Response status:', res.status);
                console.log('Response statusText:', res.statusText);
                console.log('Response ok:', res.ok);
                console.log('Response type:', res.type);
                console.log('Response headers:', Object.fromEntries(res.headers.entries()));
                const resClone = res.clone();
                const resBodyText = await resClone.text();
                console.log('Response body (text):', resBodyText);
                console.log('--- End Debugging Login Response ---');

                if (!res.ok) {
                    const errorMessage = resBodyText || res.statusText || `Status ${res.status}`;
                    throw new Error(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorMessage}`);
                }
                
                let authData;
                try {
                    authData = JSON.parse(resBodyText);
                } catch (jsonError) {
                    console.error('âŒ ë¡œê·¸ì¸ ì‘ë‹µ JSON íŒŒì‹± ì‹¤íŒ¨:', jsonError, 'ì›ì‹œ ì‘ë‹µ:', resBodyText);
                    throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }

                saveTokens(authData.data.accessToken, authData.data.refreshToken);
                console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ');
                return authData.data;
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬ ì¤‘ ìµœì¢… ì˜¤ë¥˜:', error);
                alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì‘ë‹µ ì²˜ë¦¬ ì‹¤íŒ¨'}`);
                throw error;
            }
        }

        async function doLogout() {
            if (!refreshToken) {
                console.log('âš ï¸ ë¦¬í”„ë ˆì‹œ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ì´ë¯¸ ë¡œê·¸ì•„ì›ƒë˜ì—ˆê±°ë‚˜ í† í°ì´ ë°œê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            try {
                const res = await fetch(
                    API.logout,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ refreshToken: refreshToken }) }
                );
                if (!res.ok) throw new Error(await res.text());
                console.log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            } finally {
                clearTokens();
            }
        }

        async function doWithdraw() {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(API.withdraw, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            clearTokens();
            console.log('âœ… íšŒì›íƒˆí‡´ ì™„ë£Œ');
        }

        async function doGetProfile() {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(API.getProfile);
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            console.log('ğŸ” ë‚´ í”„ë¡œí•„ (ë‹‰ë„¤ì„, URL):', data.data);
            return data.data;
        }

        async function doUpdateProfile(data) {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(
                API.updateProfile,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            const updatedData = await res.json();
            console.log('âœ… í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ:', updatedData.data);
            return updatedData.data;
        }

        async function doUpdateEmail(data) {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(
                API.updateEmail,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('âœ… ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½ ì™„ë£Œ.'); // í…ìŠ¤íŠ¸ ë³€ê²½
            alert('ğŸ”” ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½ìœ¼ë¡œ ì¸í•´ ì„¸ì…˜ì´ ì¢…ë£Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            clearTokens();
            navigate('/auth');
        }

        async function doUpdatePhoneNumber(data) {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(
                API.updatePhoneNumber,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('âœ… ì „í™”ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ.');
        }

        async function doUserDetails() {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(API.getUserDetails);
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            console.log('ğŸ” ë‚´ ìƒì„¸ ì •ë³´:', data.data);
            return data.data;
        }

        async function doChangePW(data) {
            if (!accessToken) {
                console.log('âš ï¸ ì•¡ì„¸ìŠ¤ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤.');
                throw new Error('ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ.');
            }
            const res = await fetchWithAuth(
                API.changePW,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('âœ… ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ. ì¬ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            clearTokens();
            navigate('/auth');
        }

        async function doRefresh() {
            console.log('--- Debugging doRefresh Start ---');
            console.log('doRefresh: isRefreshing (ì´ˆê¸°ê°’) =', isRefreshing);
            console.log('doRefresh: refreshToken (ê¸€ë¡œë²Œ) =', refreshToken ? refreshToken.substring(0, 10) + '...' : 'null');
            console.log('--- End Debugging doRefresh Start ---');
            if (isRefreshing) {
                return new Promise(resolve => {
                    failedQueue.push(token => { resolve(token); });
                });
            }
            isRefreshing = true;

            console.log("âŸ³ ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰ ì‹œë„ ì¤‘...");
            if (!refreshToken) {
                console.log('âš ï¸ ë¦¬í”„ë ˆì‹œ í† í°ì´ ì—†ì–´ ì¬ë°œê¸‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                isRefreshing = false;
                throw new Error('ë¦¬í”„ë ˆì‹œ í† í° ì—†ìŒ.');
            }
            
            try {
                const res = await fetch(
                  API.refresh,
                {
                    method: 'POST', // ë°±ì—”ë“œ APIê°€ POSTë¥¼ ì˜ˆìƒí•˜ë¯€ë¡œ POST ìœ ì§€
                    headers: {
                        'Content-Type': 'application/json', // ë°±ì—”ë“œê°€ @RequestBodyë¥¼ ë°›ì§€ ì•Šì•„ë„ Content-Typeì€ ë³´ë‚´ëŠ” ê²ƒì´ ì¼ë°˜ì 
                        'Authorization': `Bearer ${refreshToken}` // âœ¨ Refresh Tokenì„ Authorization í—¤ë”ì— ë‹´ì•„ ì „ì†¡ âœ¨
                    },
                    body: JSON.stringify({}) // ë°±ì—”ë“œê°€ @RequestBodyë¥¼ ì˜ˆìƒí•˜ì§€ ì•Šì•„ë„, ëª…ì‹œì ìœ¼ë¡œ ë¹ˆ JSON ê°ì²´ë¥¼ ë³´ë‚´ëŠ” ê²ƒì´ ì•ˆì „
                                             // ë°±ì—”ë“œê°€ @RequestBodyë¥¼ ì „í˜€ ì˜ˆìƒí•˜ì§€ ì•Šê³  í—¤ë”ë§Œ ë°›ëŠ”ë‹¤ë©´ body: nullë„ ê°€ëŠ¥
                                             // í•˜ì§€ë§Œ ì•ˆì •ì„±ì„ ìœ„í•´ ë¹ˆ ê°ì²´ ì „ì†¡ì„ ìœ ì§€í•©ë‹ˆë‹¤.
                }
            );
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`ì¬ë°œê¸‰ ì‹¤íŒ¨: ${res.status} - ${errorText}`);
                }
                
                const data = await res.json();
                const newAccessToken = data.data.accessToken;
                const newRefreshToken = data.data.refreshToken || refreshToken;

                saveTokens(newAccessToken, newRefreshToken);
                console.log('âœ… ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰ ì™„ë£Œ');

                failedQueue.forEach(cb => cb(newAccessToken));
                failedQueue = [];
                return newAccessToken;

            } catch (error) {
                console.error('âŒ ì•¡ì„¸ìŠ¤ í† í° ì¬ë°œê¸‰ ì‹¤íŒ¨:', error);
                failedQueue.forEach(cb => cb(null));
                failedQueue = [];
                throw error;
            } finally {
                isRefreshing = false;
            }
        }


        // --- ë¼ìš°íŒ… ë° ì½˜í…ì¸  ë¡œë“œ í•¨ìˆ˜ ---
        async function loadContent(path) {
            const contentDiv = document.getElementById('content');
            let htmlToLoad = '';

            switch(path) {
                case '/':
                    htmlToLoad = `
                        <h1>Bob Mating</h1>
                        <p style="text-align: center; font-size: 1.2em; color: #555;">ë‹¹ì‹ ì˜ ì™„ë²½í•œ íŒŒíŠ¸ë„ˆë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</p>
                        <p style="text-align: center; margin-top: 30px;">ë¡œê·¸ì¸í•˜ì—¬ ì‹œì‘í•˜ê±°ë‚˜, í”„ë¡œí•„ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p>
                    `;
                    break;
                case '/auth':
                    htmlToLoad = `
                        <h1>ì¸ì¦ í˜ì´ì§€</h1>
                        <div class="toggle-buttons">
                            <button id="showLogin" class="active">ë¡œê·¸ì¸</button>
                            <button id="showRegister">íšŒì›ê°€ì…</button>
                        </div>

                        <div id="loginSection" class="form-section active">
                            <h2>ë¡œê·¸ì¸</h2>
                            <form id="loginForm">
                                <label for="loginEmail">ì‚¬ìš©ìëª… (Email):</label><br>
                                <input type="text" id="loginEmail" name="email" required><br><br>
                                <label for="loginPassword">ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="loginPassword" name="password" required><br><br>
                                <button type="submit">ë¡œê·¸ì¸</button>
                            </form>
                        </div>

                        <div id="registerSection" class="form-section">
                            <h2>íšŒì›ê°€ì…</h2>
                            <form id="registerForm">
                                <label for="regEmail">ì´ë©”ì¼:</label><br>
                                <input type="text" id="regEmail" name="email" required><br><br>
                                <label for="regPassword">ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="regPassword" name="password" required><br><br>
                                <label for="regNickname">ë‹‰ë„¤ì„:</label><br>
                                <input type="text" id="regNickname" name="nickname" required><br><br>
                                <label for="regGender">ì„±ë³„:</label><br>
                                <select id="regGender" name="gender" required>
                                    <option value="">ì„ íƒ</option>
                                    <option value="MALE">ë‚¨ì„±</option>
                                    <option value="FEMALE">ì—¬ì„±</option>
                                </select><br><br>
                                <label for="regAge">ë‚˜ì´:</label><br>
                                <input type="number" id="regAge" name="age" required min="0" max="150"><br><br>
                                <label for="regPhoneNumber">í•¸ë“œí° ë²ˆí˜¸:</label><br>
                                <input type="text" id="regPhoneNumber" name="phoneNumber" required><br><br>
                                <label for="regProfileImageUrl">í”„ë¡œí•„ ì´ë¯¸ì§€ URL (ì„ íƒ):</label><br>
                                <input type="url" id="regProfileImageUrl" name="profileImageUrl"><br><br>
                                <button type="submit">íšŒì›ê°€ì… ì™„ë£Œ</button>
                            </form>
                        </div>
                    `;
                    break;
                case '/profile':
                    htmlToLoad = `
                        <h1>ë‚´ í”„ë¡œí•„</h1>
                        <div class="action-group">
                            <button id="getProfileButton">ë‚´ í”„ë¡œí•„ (ë‹‰ë„¤ì„/URL) ì¡°íšŒ</button>
                            <button id="getUserDetailsButton">ë‚´ ìƒì„¸ ì •ë³´ ì¡°íšŒ (ì „ì²´)</button>
                            <pre id="profileRawData" style="display: none;"></pre>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">í”„ë¡œí•„ ìˆ˜ì •</h3>
                            <form id="updateProfileForm">
                                <label for="updateNickname">ìƒˆ ë‹‰ë„¤ì„:</label><br>
                                <input type="text" id="updateNickname" name="nickname" placeholder="ìƒˆ ë‹‰ë„¤ì„"><br>
                                <label for="updateProfileImageUrl">ìƒˆ í”„ë¡œí•„ ì´ë¯¸ì§€ URL:</label><br>
                                <input type="url" id="updateProfileImageUrl" name="profileImageUrl" placeholder="ìƒˆ í”„ë¡œí•„ ì´ë¯¸ì§€ URL (ì„ íƒ)"><br>
                                <button type="submit">í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½</h3>
                            <form id="updateEmailForm">
                                <label for="newEmail">ìƒˆ ì•„ì´ë””(ì´ë©”ì¼):</label><br>
                                <input type="text" id="newEmail" name="newEmail" required><br>
                                <label for="currentPasswordEmail">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="currentPasswordEmail" name="currentPassword" required><br>
                                <button type="submit">ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">ì „í™”ë²ˆí˜¸ ë³€ê²½</h3>
                            <form id="updatePhoneNumberForm">
                                <label for="newPhoneNumber">ìƒˆ ì „í™”ë²ˆí˜¸:</label><br>
                                <input type="text" id="newPhoneNumber" name="newPhoneNumber" required><br>
                                <label for="currentPasswordPhone">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="currentPasswordPhone" name="currentPassword" required><br>
                                <button type="submit">ì „í™”ë²ˆí˜¸ ë³€ê²½</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                            <form id="changePWForm">
                                <label for="oldPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="oldPassword" name="oldPassword" required><br>
                                <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸:</label><br>
                                <input type="password" id="newPassword" name="newPassword" required><br>
                                <button type="submit">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">ê³„ì • ê´€ë¦¬</h3>
                            <button id="withdrawButton" style="background-color: #dc3545;">íšŒì›íƒˆí‡´</button>
                        </div>
                    `;
                    break;
                case '/api-playground': // ìƒˆë¡œìš´ API Playground í˜ì´ì§€
                    htmlToLoad = `
                        <h1>API Playground</h1>
                        <p>ì´ê³³ì—ì„œ ë‹¤ì–‘í•œ API í˜¸ì¶œì„ í…ŒìŠ¤íŠ¸í•˜ê³  ì½˜ì†”ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                        <div class="api-group">
                            <h3 class="section-header">ê³µê°œ API í…ŒìŠ¤íŠ¸</h3>
                            <button id="testApiEndpointButton">í…ŒìŠ¤íŠ¸ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ (/api/test)</button>
                        </div>
                        `;
                    break;
                default:
                    htmlToLoad = '<h1>404 Not Found</h1><p>í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            contentDiv.innerHTML = htmlToLoad;
            attachEventListeners(path);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë™ì ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜
        function attachEventListeners(path) {
            if (path === '/') {
                // í™ˆ í˜ì´ì§€ì—ëŠ” ë³„ë„ì˜ API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ì´ ì—†ìŠµë‹ˆë‹¤.
            } else if (path === '/auth') {
                const showLoginButton = document.getElementById('showLogin');
                const showRegisterButton = document.getElementById('showRegister');
                const loginSection = document.getElementById('loginSection');
                const registerSection = document.getElementById('registerSection');

                function showForm(formType) {
                    if (formType === 'login') {
                        loginSection.classList.add('active');
                        registerSection.classList.remove('active');
                        showLoginButton.classList.add('active');
                        showRegisterButton.classList.remove('active');
                    } else {
                        registerSection.classList.add('active');
                        loginSection.classList.remove('active');
                        showRegisterButton.classList.add('active');
                        showLoginButton.classList.remove('active');
                    }
                }

                if (showLoginButton && showRegisterButton) {
                    showLoginButton.onclick = () => showForm('login');
                    showRegisterButton.onclick = () => showForm('register');
                    showForm('login'); // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ë¡œê·¸ì¸ í¼ì„ ë³´ì—¬ì¤Œ
                }

                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const email = loginForm.elements.email.value;
                        const password = loginForm.elements.password.value;

                        try {
                            await doLogin({ email, password });
                            alert(`ë¡œê·¸ì¸ ì„±ê³µ!`);
                            navigate('/');
                        } catch (error) {
                            console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                            alert(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                        }
                    };
                }

                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const email = registerForm.elements.email.value;
                        const password = registerForm.elements.password.value;
                        const nickname = registerForm.elements.nickname.value;
                        const gender = registerForm.elements.gender.value;
                        const age = parseInt(registerForm.elements.age.value, 10);
                        const phoneNumber = registerForm.elements.phoneNumber.value;
                        const profileImageUrl = registerForm.elements.profileImageUrl.value || null;

                        if (!email || !password || !nickname || !gender || isNaN(age) || !phoneNumber) {
                            alert('ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                            return;
                        }
                        if (gender !== 'MALE' && gender !== 'FEMALE') {
                            alert('ì„±ë³„ì€ MALE ë˜ëŠ” FEMALEì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                            return;
                        }
                        if (age < 0 || age > 150) {
                            alert('ë‚˜ì´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                            return;
                        }

                        try {
                            await doSignup({
                                email, password, nickname, gender, age, phoneNumber, profileImageUrl
                            });
                            alert('íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                            showForm('login');
                        } catch (error) {
                            console.error('íšŒì›ê°€ì… ì‹¤íŒ¨:', error);
                            alert(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                        }
                    };
                }
            } else if (path === '/profile') {
                const getProfileButton = document.getElementById('getProfileButton');
                const getUserDetailsButton = document.getElementById('getUserDetailsButton');
                const profileRawDataPre = document.getElementById('profileRawData');

                if (getProfileButton) {
                    getProfileButton.onclick = async () => {
                        try {
                            const data = await doGetProfile();
                            profileRawDataPre.innerText = JSON.stringify(data, null, 2);
                            profileRawDataPre.style.display = 'block';
                            alert('ë‚´ í”„ë¡œí•„ (ë‹‰ë„¤ì„/URL) ì¡°íšŒ ì„±ê³µ! ì½˜ì†”ê³¼ í™”ë©´ í™•ì¸.');
                        } catch(error) {
                            console.error('ë‚´ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                            alert('ë‚´ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            profileRawDataPre.style.display = 'none';
                        }
                    };
                }
                if(getUserDetailsButton) {
                    getUserDetailsButton.onclick = async () => {
                        try {
                            const data = await doUserDetails();
                            profileRawDataPre.innerText = JSON.stringify(data, null, 2);
                            profileRawDataPre.style.display = 'block';
                            alert('ë‚´ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì„±ê³µ! ì½˜ì†”ê³¼ í™”ë©´ í™•ì¸.');
                        } catch(error) {
                            console.error('ë‚´ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                            alert('ë‚´ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            profileRawDataPre.style.display = 'none';
                        }
                    };
                }
                
                const updateProfileForm = document.getElementById('updateProfileForm');
                if(updateProfileForm) {
                    updateProfileForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const nickname = updateProfileForm.elements.nickname.value;
                        const profileImageUrl = updateProfileForm.elements.profileImageUrl.value || null;
                        try {
                            const data = await doUpdateProfile({ nickname, profileImageUrl });
                            alert('í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ!');
                            console.log('í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ:', data);
                            updateProfileForm.reset();
                        } catch (error) {
                            console.error('í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨:', error);
                            alert('í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        }
                    };
                }

                const updateEmailForm = document.getElementById('updateEmailForm');
                if(updateEmailForm) {
                    updateEmailForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const newEmail = updateEmailForm.elements.newEmail.value;
                        const currentPassword = updateEmailForm.elements.currentPassword.value;
                        try {
                            await doUpdateEmail({ newEmail, currentPassword });
                            alert('ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½ ìš”ì²­ ì™„ë£Œ. ì¬ë¡œê·¸ì¸ í•„ìš”.');
                            updateEmailForm.reset();
                        } catch (error) {
                            console.error('ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½ ì‹¤íŒ¨:', error);
                            alert('ì•„ì´ë””(ì´ë©”ì¼) ë³€ê²½ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        }
                    };
                }

                const updatePhoneNumberForm = document.getElementById('updatePhoneNumberForm');
                if(updatePhoneNumberForm) {
                    updatePhoneNumberForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const newPhoneNumber = updatePhoneNumberForm.elements.newPhoneNumber.value;
                        const currentPassword = updatePhoneNumberForm.elements.currentPassword.value;
                        try {
                            await doUpdatePhoneNumber({ newPhoneNumber, currentPassword });
                            alert('ì „í™”ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ!');
                            updatePhoneNumberForm.reset();
                        } catch (error) {
                            console.error('ì „í™”ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
                            alert('ì „í™”ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        }
                    };
                }

                const changePWForm = document.getElementById('changePWForm');
                if(changePWForm) {
                    changePWForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const oldPassword = changePWForm.elements.oldPassword.value;
                        const newPassword = changePWForm.elements.newPassword.value;
                        try {
                            await doChangePW({ oldPassword, newPassword });
                            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ìš”ì²­ ì™„ë£Œ. ì¬ë¡œê·¸ì¸ í•„ìš”.');
                            changePWForm.reset();
                        } catch (error) {
                            console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
                            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        }
                    };
                }

                const withdrawButton = document.getElementById('withdrawButton');
                if(withdrawButton) {
                    withdrawButton.onclick = async () => {
                        if (confirm('ì •ë§ íšŒì›íƒˆí‡´ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                            try {
                                await doWithdraw();
                                alert('íšŒì›íƒˆí‡´ ì™„ë£Œ.');
                                navigate('/');
                            } catch (error) {
                                console.error('íšŒì›íƒˆí‡´ ì‹¤íŒ¨:', error);
                                alert('íšŒì›íƒˆí‡´ ì‹¤íŒ¨: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            }
                        }
                    };
                }
            } else if (path === '/api-playground') { // ìƒˆë¡œìš´ API Playground í˜ì´ì§€ì—ë§Œ API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ì—°ê²°
                const testApiEndpointButton = document.getElementById('testApiEndpointButton');
                if (testApiEndpointButton) {
                    testApiEndpointButton.onclick = async () => {
                        try {
                            const response = await fetch(API.test);
                            const data = await response.text();
                            alert(`API í…ŒìŠ¤íŠ¸ ì‘ë‹µ: ${data}\nì½˜ì†” í™•ì¸`);
                            console.log('API í…ŒìŠ¤íŠ¸ ì‘ë‹µ:', data);
                        } catch (error) {
                            console.error('API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                            alert('API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
                        }
                    };
                }
            }
        }

        // ë¼ìš°íŒ… ì²˜ë¦¬ (SPA í•µì‹¬)
        function navigate(path) {
            if (window.location.pathname === path) {
                loadContent(path);
                return;
            }
            history.pushState(null, '', path);
            loadContent(path);
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ í˜„ì¬ URLì— ë§ëŠ” ì½˜í…ì¸  ë¡œë“œ ë° í† í° ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            // í—¤ë” ë¡œê³  í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (DOMì´ ë¡œë“œë  ë•Œë§Œ)
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.addEventListener('click', () => navigate('/'));
            }

            loadTokens();
            loadContent(window.location.pathname);
            
            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” DOMContentLoaded ì‹œì ì— í•œ ë²ˆë§Œ ë“±ë¡
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    clearTokens();
                    alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    navigate('/');
                });
            }
        });

        // ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
        window.addEventListener('popstate', () => {
            loadContent(window.location.pathname);
        });

        // ë‚´ë¹„ê²Œì´ì…˜ ë§í¬ í´ë¦­ ì²˜ë¦¬
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const route = e.target.dataset.route;
                navigate(route);
            });
        });

    </script>
</body>
</html>