<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bob Mating</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; color: #333; }
        header { background-color: #4CAF50; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header .logo { font-size: 1.8em; font-weight: bold; cursor: pointer; }
        nav { display: flex; align-items: center; }
        nav a, nav button { margin-left: 20px; text-decoration: none; color: white; background: none; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; }
        nav a:hover, nav button:hover { background-color: rgba(255,255,255,0.2); }
        nav button#logoutButton { background-color: #e74c3c; }
        nav button#logoutButton:hover { background-color: #c0392b; }
        
        main { padding: 40px 20px; max-width: 900px; margin: 20px auto; background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        
        /* Form & Section Styles */
        .form-section { display: none; margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .form-section.active { display: block; }
        input[type="text"], input[type="password"], input[type="number"], input[type="url"], select {
            width: calc(100% - 20px); /* Adjust for padding */
            padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        button[type="submit"], .action-button { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; margin-top: 10px; }
        button[type="submit"]:hover, .action-button:hover { background-color: #218838; }
        
        .toggle-buttons { display: flex; justify-content: center; margin-bottom: 20px; }
        .toggle-buttons button { background-color: #6c757d; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin: 0 5px; }
        .toggle-buttons button.active { background-color: #007bff; }

        /* API Playground Specific Styles */
        .api-playground-section { padding: 20px; }
        .api-group { margin-bottom: 30px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px; background-color: #f8f9fa; }
        .api-group h3 { color: #495057; margin-top: 0; border-bottom: 1px dashed #ced4da; padding-bottom: 10px; }
        .api-group button { margin-bottom: 10px; width: auto; min-width: 150px; } /* Adjust button width */
        .api-group form { margin-top: 15px; }
        .api-group label { margin-bottom: 5px; display: block; font-weight: bold; }
        .api-group input[type="password"] { margin-bottom: 20px; } /* For password fields */
        
        pre { background-color: #e9ecef; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9em; margin-top: 15px; }
    </style>
</head>
<body>
    <header>
        <div class="logo" data-route="/">Bob Mating</div>
        <nav>
            <a href="/auth" data-route="/auth" id="authNavButton">로그인/회원가입</a>
            <a href="/profile" data-route="/profile" id="profileNavButton" style="display: none;">내 프로필</a>
            <a href="/api-playground" data-route="/api-playground" id="apiPlaygroundNavButton" style="display: none;">API Playground</a>
            <button id="logoutButton" style="display: none;">로그아웃</button>
        </nav>
    </header>

    <main id="content">
        </main>

    <script>
        // --- API 엔드포인트 정의 ---
        const API = {
            signup: 'http://localhost:8080/api/user/signup',
            login: 'http://localhost:8080/api/auth/login',
            getProfile: 'http://localhost:8080/api/user/profile',
            updateProfile: 'http://localhost:8080/api/user/profile',
            updateEmail: 'http://localhost:8080/api/user/email',
            updatePhoneNumber: 'http://localhost:8080/api/user/phone-number',
            getUserDetails: 'http://localhost:8080/api/user/me/details',
            changePW: 'http://localhost:8080/api/user/password',
            logout: 'http://localhost:8080/api/auth/logout',
            withdraw: 'http://localhost:8080/api/user/withdraw',
            refresh: 'http://localhost:8080/api/auth/refresh',
            test: 'http://localhost:8080/api/test' // 테스트용 API
        };

        // --- JWT 토큰 관련 전역 변수 및 함수 ---
        let accessToken = null;
        let refreshToken = null;
        let isRefreshing = false;
        let failedQueue = [];

        function loadTokens() {
            accessToken = localStorage.getItem('accessToken');
            refreshToken = localStorage.getItem('refreshToken');
            updateNavUI(); // 네비게이션 UI 업데이트 함수 호출
            console.log('✅ 토큰 로드 완료 (액세스:', !!accessToken, '리프레시:', !!refreshToken, ')');
        }

        function saveTokens(access, refresh) {
            localStorage.setItem('accessToken', access);
            localStorage.setItem('refreshToken', refresh);
            accessToken = access;
            refreshToken = refresh;
            updateNavUI(); // 네비게이션 UI 업데이트 함수 호출
            console.log('✅ 토큰 저장 완료.');
        }

        function clearTokens() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            accessToken = null;
            refreshToken = null;
            updateNavUI(); // 네비게이션 UI 업데이트 함수 호출
            console.log('🗑️ 토큰 제거 완료.');
        }

        // 네비게이션 바의 버튼 가시성을 업데이트하는 함수
        function updateNavUI() {
            const authNavButton = document.getElementById('authNavButton');
            const profileNavButton = document.getElementById('profileNavButton');
            const apiPlaygroundNavButton = document.getElementById('apiPlaygroundNavButton');
            const logoutButton = document.getElementById('logoutButton');

            if (authNavButton && profileNavButton && apiPlaygroundNavButton && logoutButton) {
                if (accessToken) {
                    authNavButton.style.display = 'none';
                    profileNavButton.style.display = 'inline';
                    apiPlaygroundNavButton.style.display = 'inline'; // 로그인 시 API Playground도 보이도록
                    logoutButton.style.display = 'inline';
                } else {
                    authNavButton.style.display = 'inline';
                    profileNavButton.style.display = 'none';
                    apiPlaygroundNavButton.style.display = 'none'; // 로그아웃 시 API Playground 숨김
                    logoutButton.style.display = 'none';
                }
            }
        }

        // --- Fetch API 기반 요청 함수 (인터셉터 로직 포함) ---
        async function fetchWithAuth(url, options = {}) {
            let headers = options.headers || {};
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            options.headers = headers;

            try {
                const response = await fetch(url, options);
                console.log(`✅ [RESPONSE] ${response.status} ${url}`);

                if (response.status === 401 && !options._retry) {
                    options._retry = true;
                    console.log('액세스 토큰 만료 또는 유효하지 않음. 재발급 시도...');

                    try {
                        const newAccessToken = await doRefresh();
                        // --- 여기에 디버깅 로그 수정 시작 ---
                        console.log('--- Debugging Retry Request Headers ---');
                        console.log('New Access Token from doRefresh:', newAccessToken ? newAccessToken.substring(0, 10) + '...' : 'null');
                        console.log('Current global accessToken:', accessToken ? accessToken.substring(0, 10) + '...' : 'null'); // 전역 변수 확인
                        
                        // 재시도 요청에 Authorization 헤더를 명시적으로 재설정
                        headers['Authorization'] = `Bearer ${newAccessToken}`;
                        options.headers = headers; // options.headers 객체에 변경사항 적용

                        // Headers 객체의 entries()를 사용하여 안전하게 로깅
                        // options.headers가 일반 객체라면 그대로 로깅
                        // Headers 객체라면 Object.fromEntries(new Headers(options.headers).entries())
                        // 가장 안전한 방법은 `fetch`가 적용할 최종 `Headers` 객체를 직접 로깅하는 것입니다.
                        // `fetch`는 `options.headers`가 일반 객체여도 `Headers` 객체로 변환하여 사용하므로,
                        // 여기서는 `options.headers` 객체 자체를 로깅해도 충분합니다.
                        console.log('Retry request headers (will apply this):', { ...options.headers }); // 수정된 로깅
                        console.log('--- End Debugging Retry Request Headers ---');
                        // --- 디버깅 로그 수정 끝 ---

                        const retryResponse = await fetch(url, options);
                        console.log(`✅ [RETRY RESPONSE] ${retryResponse.status} ${url}`);
                        return retryResponse;
                    } catch (refreshError) {
                        console.error('❌ 액세스 토큰 재발급 실패. 다시 로그인하세요.', refreshError);
                        clearTokens();
                        navigate('/auth');
                        throw refreshError;
                    }
                }
                return response;
            } catch (error) {
                console.error(`❌ [REQUEST ERROR] ${url}`, error);
                throw error;
            }
        }

        // --- 헬퍼 함수들 (API 호출 로직) ---

        async function doSignup(data) {
            const res = await fetchWithAuth(
                API.signup,
                { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('✅ 회원가입 완료');
            return res;
        }

        async function doLogin(data) {
            let res;
            try {
                res = await fetchWithAuth(
                    API.login,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
                );

                console.log('--- Debugging Login Response ---');
                console.log('Response URL:', res.url);
                console.log('Response status:', res.status);
                console.log('Response statusText:', res.statusText);
                console.log('Response ok:', res.ok);
                console.log('Response type:', res.type);
                console.log('Response headers:', Object.fromEntries(res.headers.entries()));
                const resClone = res.clone();
                const resBodyText = await resClone.text();
                console.log('Response body (text):', resBodyText);
                console.log('--- End Debugging Login Response ---');

                if (!res.ok) {
                    const errorMessage = resBodyText || res.statusText || `Status ${res.status}`;
                    throw new Error(`로그인 실패: ${errorMessage}`);
                }
                
                let authData;
                try {
                    authData = JSON.parse(resBodyText);
                } catch (jsonError) {
                    console.error('❌ 로그인 응답 JSON 파싱 실패:', jsonError, '원시 응답:', resBodyText);
                    throw new Error('로그인 실패: 서버 응답 형식이 올바르지 않습니다.');
                }

                saveTokens(authData.data.accessToken, authData.data.refreshToken);
                console.log('✅ 로그인 성공');
                return authData.data;
            } catch (error) {
                console.error('로그인 요청 처리 중 최종 오류:', error);
                alert(`로그인 실패: ${error.message || '네트워크 오류 또는 응답 처리 실패'}`);
                throw error;
            }
        }

        async function doLogout() {
            if (!refreshToken) {
                console.log('⚠️ 리프레시 토큰이 없습니다. 이미 로그아웃되었거나 토큰이 발급되지 않았습니다.');
                return;
            }
            try {
                const res = await fetch(
                    API.logout,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ refreshToken: refreshToken }) }
                );
                if (!res.ok) throw new Error(await res.text());
                console.log('✅ 로그아웃 완료');
            } finally {
                clearTokens();
            }
        }

        async function doWithdraw() {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(API.withdraw, { method: 'DELETE' });
            if (!res.ok) throw new Error(await res.text());
            clearTokens();
            console.log('✅ 회원탈퇴 완료');
        }

        async function doGetProfile() {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(API.getProfile);
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            console.log('🔎 내 프로필 (닉네임, URL):', data.data);
            return data.data;
        }

        async function doUpdateProfile(data) {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(
                API.updateProfile,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            const updatedData = await res.json();
            console.log('✅ 프로필 수정 완료:', updatedData.data);
            return updatedData.data;
        }

        async function doUpdateEmail(data) {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(
                API.updateEmail,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('✅ 아이디(이메일) 변경 완료.'); // 텍스트 변경
            alert('🔔 아이디(이메일) 변경으로 인해 세션이 종료될 수 있습니다. 다시 로그인해주세요.');
            clearTokens();
            navigate('/auth');
        }

        async function doUpdatePhoneNumber(data) {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(
                API.updatePhoneNumber,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('✅ 전화번호 변경 완료.');
        }

        async function doUserDetails() {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(API.getUserDetails);
            if (!res.ok) throw new Error(await res.text());
            const data = await res.json();
            console.log('🔎 내 상세 정보:', data.data);
            return data.data;
        }

        async function doChangePW(data) {
            if (!accessToken) {
                console.log('⚠️ 액세스 토큰이 없습니다. 로그인 상태가 아닙니다.');
                throw new Error('액세스 토큰 없음.');
            }
            const res = await fetchWithAuth(
                API.changePW,
                { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }
            );
            if (!res.ok) throw new Error(await res.text());
            console.log('✅ 비밀번호 변경 완료. 재로그인해주세요.');
            clearTokens();
            navigate('/auth');
        }

        async function doRefresh() {
            console.log('--- Debugging doRefresh Start ---');
            console.log('doRefresh: isRefreshing (초기값) =', isRefreshing);
            console.log('doRefresh: refreshToken (글로벌) =', refreshToken ? refreshToken.substring(0, 10) + '...' : 'null');
            console.log('--- End Debugging doRefresh Start ---');
            if (isRefreshing) {
                return new Promise(resolve => {
                    failedQueue.push(token => { resolve(token); });
                });
            }
            isRefreshing = true;

            console.log("⟳ 액세스 토큰 재발급 시도 중...");
            if (!refreshToken) {
                console.log('⚠️ 리프레시 토큰이 없어 재발급할 수 없습니다. 로그인해주세요.');
                isRefreshing = false;
                throw new Error('리프레시 토큰 없음.');
            }
            
            try {
                const res = await fetch(
                  API.refresh,
                {
                    method: 'POST', // 백엔드 API가 POST를 예상하므로 POST 유지
                    headers: {
                        'Content-Type': 'application/json', // 백엔드가 @RequestBody를 받지 않아도 Content-Type은 보내는 것이 일반적
                        'Authorization': `Bearer ${refreshToken}` // ✨ Refresh Token을 Authorization 헤더에 담아 전송 ✨
                    },
                    body: JSON.stringify({}) // 백엔드가 @RequestBody를 예상하지 않아도, 명시적으로 빈 JSON 객체를 보내는 것이 안전
                                             // 백엔드가 @RequestBody를 전혀 예상하지 않고 헤더만 받는다면 body: null도 가능
                                             // 하지만 안정성을 위해 빈 객체 전송을 유지합니다.
                }
            );
                
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`재발급 실패: ${res.status} - ${errorText}`);
                }
                
                const data = await res.json();
                const newAccessToken = data.data.accessToken;
                const newRefreshToken = data.data.refreshToken || refreshToken;

                saveTokens(newAccessToken, newRefreshToken);
                console.log('✅ 액세스 토큰 재발급 완료');

                failedQueue.forEach(cb => cb(newAccessToken));
                failedQueue = [];
                return newAccessToken;

            } catch (error) {
                console.error('❌ 액세스 토큰 재발급 실패:', error);
                failedQueue.forEach(cb => cb(null));
                failedQueue = [];
                throw error;
            } finally {
                isRefreshing = false;
            }
        }


        // --- 라우팅 및 콘텐츠 로드 함수 ---
        async function loadContent(path) {
            const contentDiv = document.getElementById('content');
            let htmlToLoad = '';

            switch(path) {
                case '/':
                    htmlToLoad = `
                        <h1>Bob Mating</h1>
                        <p style="text-align: center; font-size: 1.2em; color: #555;">당신의 완벽한 파트너를 찾아보세요.</p>
                        <p style="text-align: center; margin-top: 30px;">로그인하여 시작하거나, 프로필을 확인해보세요.</p>
                    `;
                    break;
                case '/auth':
                    htmlToLoad = `
                        <h1>인증 페이지</h1>
                        <div class="toggle-buttons">
                            <button id="showLogin" class="active">로그인</button>
                            <button id="showRegister">회원가입</button>
                        </div>

                        <div id="loginSection" class="form-section active">
                            <h2>로그인</h2>
                            <form id="loginForm">
                                <label for="loginEmail">사용자명 (Email):</label><br>
                                <input type="text" id="loginEmail" name="email" required><br><br>
                                <label for="loginPassword">비밀번호:</label><br>
                                <input type="password" id="loginPassword" name="password" required><br><br>
                                <button type="submit">로그인</button>
                            </form>
                        </div>

                        <div id="registerSection" class="form-section">
                            <h2>회원가입</h2>
                            <form id="registerForm">
                                <label for="regEmail">이메일:</label><br>
                                <input type="text" id="regEmail" name="email" required><br><br>
                                <label for="regPassword">비밀번호:</label><br>
                                <input type="password" id="regPassword" name="password" required><br><br>
                                <label for="regNickname">닉네임:</label><br>
                                <input type="text" id="regNickname" name="nickname" required><br><br>
                                <label for="regGender">성별:</label><br>
                                <select id="regGender" name="gender" required>
                                    <option value="">선택</option>
                                    <option value="MALE">남성</option>
                                    <option value="FEMALE">여성</option>
                                </select><br><br>
                                <label for="regAge">나이:</label><br>
                                <input type="number" id="regAge" name="age" required min="0" max="150"><br><br>
                                <label for="regPhoneNumber">핸드폰 번호:</label><br>
                                <input type="text" id="regPhoneNumber" name="phoneNumber" required><br><br>
                                <label for="regProfileImageUrl">프로필 이미지 URL (선택):</label><br>
                                <input type="url" id="regProfileImageUrl" name="profileImageUrl"><br><br>
                                <button type="submit">회원가입 완료</button>
                            </form>
                        </div>
                    `;
                    break;
                case '/profile':
                    htmlToLoad = `
                        <h1>내 프로필</h1>
                        <div class="action-group">
                            <button id="getProfileButton">내 프로필 (닉네임/URL) 조회</button>
                            <button id="getUserDetailsButton">내 상세 정보 조회 (전체)</button>
                            <pre id="profileRawData" style="display: none;"></pre>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">프로필 수정</h3>
                            <form id="updateProfileForm">
                                <label for="updateNickname">새 닉네임:</label><br>
                                <input type="text" id="updateNickname" name="nickname" placeholder="새 닉네임"><br>
                                <label for="updateProfileImageUrl">새 프로필 이미지 URL:</label><br>
                                <input type="url" id="updateProfileImageUrl" name="profileImageUrl" placeholder="새 프로필 이미지 URL (선택)"><br>
                                <button type="submit">프로필 수정 완료</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">아이디(이메일) 변경</h3>
                            <form id="updateEmailForm">
                                <label for="newEmail">새 아이디(이메일):</label><br>
                                <input type="text" id="newEmail" name="newEmail" required><br>
                                <label for="currentPasswordEmail">현재 비밀번호:</label><br>
                                <input type="password" id="currentPasswordEmail" name="currentPassword" required><br>
                                <button type="submit">아이디(이메일) 변경</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">전화번호 변경</h3>
                            <form id="updatePhoneNumberForm">
                                <label for="newPhoneNumber">새 전화번호:</label><br>
                                <input type="text" id="newPhoneNumber" name="newPhoneNumber" required><br>
                                <label for="currentPasswordPhone">현재 비밀번호:</label><br>
                                <input type="password" id="currentPasswordPhone" name="currentPassword" required><br>
                                <button type="submit">전화번호 변경</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">비밀번호 변경</h3>
                            <form id="changePWForm">
                                <label for="oldPassword">현재 비밀번호:</label><br>
                                <input type="password" id="oldPassword" name="oldPassword" required><br>
                                <label for="newPassword">새 비밀번호:</label><br>
                                <input type="password" id="newPassword" name="newPassword" required><br>
                                <button type="submit">비밀번호 변경</button>
                            </form>
                        </div>

                        <div class="api-group">
                            <h3 class="section-header">계정 관리</h3>
                            <button id="withdrawButton" style="background-color: #dc3545;">회원탈퇴</button>
                        </div>
                    `;
                    break;
                case '/api-playground': // 새로운 API Playground 페이지
                    htmlToLoad = `
                        <h1>API Playground</h1>
                        <p>이곳에서 다양한 API 호출을 테스트하고 콘솔에서 결과를 확인하세요.</p>
                        <div class="api-group">
                            <h3 class="section-header">공개 API 테스트</h3>
                            <button id="testApiEndpointButton">테스트 API 엔드포인트 호출 (/api/test)</button>
                        </div>
                        `;
                    break;
                default:
                    htmlToLoad = '<h1>404 Not Found</h1><p>페이지를 찾을 수 없습니다.</p>';
            }
            contentDiv.innerHTML = htmlToLoad;
            attachEventListeners(path);
        }

        // 이벤트 리스너를 동적으로 연결하는 함수
        function attachEventListeners(path) {
            if (path === '/') {
                // 홈 페이지에는 별도의 API 테스트 버튼이 없습니다.
            } else if (path === '/auth') {
                const showLoginButton = document.getElementById('showLogin');
                const showRegisterButton = document.getElementById('showRegister');
                const loginSection = document.getElementById('loginSection');
                const registerSection = document.getElementById('registerSection');

                function showForm(formType) {
                    if (formType === 'login') {
                        loginSection.classList.add('active');
                        registerSection.classList.remove('active');
                        showLoginButton.classList.add('active');
                        showRegisterButton.classList.remove('active');
                    } else {
                        registerSection.classList.add('active');
                        loginSection.classList.remove('active');
                        showRegisterButton.classList.add('active');
                        showLoginButton.classList.remove('active');
                    }
                }

                if (showLoginButton && showRegisterButton) {
                    showLoginButton.onclick = () => showForm('login');
                    showRegisterButton.onclick = () => showForm('register');
                    showForm('login'); // 페이지 로드 시 기본적으로 로그인 폼을 보여줌
                }

                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const email = loginForm.elements.email.value;
                        const password = loginForm.elements.password.value;

                        try {
                            await doLogin({ email, password });
                            alert(`로그인 성공!`);
                            navigate('/');
                        } catch (error) {
                            console.error('로그인 실패:', error);
                            alert(`로그인 실패: ${error.message || '알 수 없는 오류'}`);
                        }
                    };
                }

                const registerForm = document.getElementById('registerForm');
                if (registerForm) {
                    registerForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const email = registerForm.elements.email.value;
                        const password = registerForm.elements.password.value;
                        const nickname = registerForm.elements.nickname.value;
                        const gender = registerForm.elements.gender.value;
                        const age = parseInt(registerForm.elements.age.value, 10);
                        const phoneNumber = registerForm.elements.phoneNumber.value;
                        const profileImageUrl = registerForm.elements.profileImageUrl.value || null;

                        if (!email || !password || !nickname || !gender || isNaN(age) || !phoneNumber) {
                            alert('모든 필수 정보를 입력해주세요.');
                            return;
                        }
                        if (gender !== 'MALE' && gender !== 'FEMALE') {
                            alert('성별은 MALE 또는 FEMALE을 선택해주세요.');
                            return;
                        }
                        if (age < 0 || age > 150) {
                            alert('나이를 올바르게 입력해주세요.');
                            return;
                        }

                        try {
                            await doSignup({
                                email, password, nickname, gender, age, phoneNumber, profileImageUrl
                            });
                            alert('회원가입 성공! 이제 로그인해주세요.');
                            showForm('login');
                        } catch (error) {
                            console.error('회원가입 실패:', error);
                            alert(`회원가입 실패: ${error.message || '알 수 없는 오류'}`);
                        }
                    };
                }
            } else if (path === '/profile') {
                const getProfileButton = document.getElementById('getProfileButton');
                const getUserDetailsButton = document.getElementById('getUserDetailsButton');
                const profileRawDataPre = document.getElementById('profileRawData');

                if (getProfileButton) {
                    getProfileButton.onclick = async () => {
                        try {
                            const data = await doGetProfile();
                            profileRawDataPre.innerText = JSON.stringify(data, null, 2);
                            profileRawDataPre.style.display = 'block';
                            alert('내 프로필 (닉네임/URL) 조회 성공! 콘솔과 화면 확인.');
                        } catch(error) {
                            console.error('내 프로필 조회 실패:', error);
                            alert('내 프로필 조회 실패: ' + (error.message || '알 수 없는 오류'));
                            profileRawDataPre.style.display = 'none';
                        }
                    };
                }
                if(getUserDetailsButton) {
                    getUserDetailsButton.onclick = async () => {
                        try {
                            const data = await doUserDetails();
                            profileRawDataPre.innerText = JSON.stringify(data, null, 2);
                            profileRawDataPre.style.display = 'block';
                            alert('내 상세 정보 조회 성공! 콘솔과 화면 확인.');
                        } catch(error) {
                            console.error('내 상세 정보 조회 실패:', error);
                            alert('내 상세 정보 조회 실패: ' + (error.message || '알 수 없는 오류'));
                            profileRawDataPre.style.display = 'none';
                        }
                    };
                }
                
                const updateProfileForm = document.getElementById('updateProfileForm');
                if(updateProfileForm) {
                    updateProfileForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const nickname = updateProfileForm.elements.nickname.value;
                        const profileImageUrl = updateProfileForm.elements.profileImageUrl.value || null;
                        try {
                            const data = await doUpdateProfile({ nickname, profileImageUrl });
                            alert('프로필 수정 완료!');
                            console.log('프로필 수정 완료:', data);
                            updateProfileForm.reset();
                        } catch (error) {
                            console.error('프로필 수정 실패:', error);
                            alert('프로필 수정 실패: ' + (error.message || '알 수 없는 오류'));
                        }
                    };
                }

                const updateEmailForm = document.getElementById('updateEmailForm');
                if(updateEmailForm) {
                    updateEmailForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const newEmail = updateEmailForm.elements.newEmail.value;
                        const currentPassword = updateEmailForm.elements.currentPassword.value;
                        try {
                            await doUpdateEmail({ newEmail, currentPassword });
                            alert('아이디(이메일) 변경 요청 완료. 재로그인 필요.');
                            updateEmailForm.reset();
                        } catch (error) {
                            console.error('아이디(이메일) 변경 실패:', error);
                            alert('아이디(이메일) 변경 실패: ' + (error.message || '알 수 없는 오류'));
                        }
                    };
                }

                const updatePhoneNumberForm = document.getElementById('updatePhoneNumberForm');
                if(updatePhoneNumberForm) {
                    updatePhoneNumberForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const newPhoneNumber = updatePhoneNumberForm.elements.newPhoneNumber.value;
                        const currentPassword = updatePhoneNumberForm.elements.currentPassword.value;
                        try {
                            await doUpdatePhoneNumber({ newPhoneNumber, currentPassword });
                            alert('전화번호 변경 완료!');
                            updatePhoneNumberForm.reset();
                        } catch (error) {
                            console.error('전화번호 변경 실패:', error);
                            alert('전화번호 변경 실패: ' + (error.message || '알 수 없는 오류'));
                        }
                    };
                }

                const changePWForm = document.getElementById('changePWForm');
                if(changePWForm) {
                    changePWForm.onsubmit = async (e) => {
                        e.preventDefault();
                        const oldPassword = changePWForm.elements.oldPassword.value;
                        const newPassword = changePWForm.elements.newPassword.value;
                        try {
                            await doChangePW({ oldPassword, newPassword });
                            alert('비밀번호 변경 요청 완료. 재로그인 필요.');
                            changePWForm.reset();
                        } catch (error) {
                            console.error('비밀번호 변경 실패:', error);
                            alert('비밀번호 변경 실패: ' + (error.message || '알 수 없는 오류'));
                        }
                    };
                }

                const withdrawButton = document.getElementById('withdrawButton');
                if(withdrawButton) {
                    withdrawButton.onclick = async () => {
                        if (confirm('정말 회원탈퇴 하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                            try {
                                await doWithdraw();
                                alert('회원탈퇴 완료.');
                                navigate('/');
                            } catch (error) {
                                console.error('회원탈퇴 실패:', error);
                                alert('회원탈퇴 실패: ' + (error.message || '알 수 없는 오류'));
                            }
                        }
                    };
                }
            } else if (path === '/api-playground') { // 새로운 API Playground 페이지에만 API 테스트 버튼 연결
                const testApiEndpointButton = document.getElementById('testApiEndpointButton');
                if (testApiEndpointButton) {
                    testApiEndpointButton.onclick = async () => {
                        try {
                            const response = await fetch(API.test);
                            const data = await response.text();
                            alert(`API 테스트 응답: ${data}\n콘솔 확인`);
                            console.log('API 테스트 응답:', data);
                        } catch (error) {
                            console.error('API 테스트 오류:', error);
                            alert('API 테스트 중 오류 발생');
                        }
                    };
                }
            }
        }

        // 라우팅 처리 (SPA 핵심)
        function navigate(path) {
            if (window.location.pathname === path) {
                loadContent(path);
                return;
            }
            history.pushState(null, '', path);
            loadContent(path);
        }

        // 초기 로드 시 현재 URL에 맞는 콘텐츠 로드 및 토큰 로드
        window.addEventListener('DOMContentLoaded', () => {
            // 헤더 로고 클릭 이벤트 리스너 (DOM이 로드될 때만)
            const logo = document.querySelector('.logo');
            if (logo) {
                logo.addEventListener('click', () => navigate('/'));
            }

            loadTokens();
            loadContent(window.location.pathname);
            
            // 로그아웃 버튼 이벤트 리스너는 DOMContentLoaded 시점에 한 번만 등록
            const logoutButton = document.getElementById('logoutButton');
            if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                    clearTokens();
                    alert('로그아웃 되었습니다.');
                    navigate('/');
                });
            }
        });

        // 뒤로가기/앞으로가기 버튼 처리
        window.addEventListener('popstate', () => {
            loadContent(window.location.pathname);
        });

        // 내비게이션 링크 클릭 처리
        document.querySelectorAll('nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const route = e.target.dataset.route;
                navigate(route);
            });
        });

    </script>
</body>
</html>